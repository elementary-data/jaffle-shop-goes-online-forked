version: 2

models:
  - name: customers
    description: "This table has basic information about a customer, as well as some derived facts based on a customer's orders"
    columns:
      - name: customer_id
        description: "This is a unique identifier for a customer"
        tests:
          - not_null
          - unique
      - name: customer_email
        description: "Customer's email. PII."
        tests:
          - unique
      - name: first_name
        description: "Customer's first name. PII."
      - name: last_name
        description: "Customer's last name. PII."
      - name: signup_date
        description: "Date (UTC) of a customer's signup to the online shop."
      - name: first_order
        description: "Date (UTC) of a customer's first order"
      - name: most_recent_order
        description: "Date (UTC) of a customer's most recent order"
      - name: number_of_orders
        description: "Count of the number of orders a customer has placed"
      - name: customer_lifetime_value
        description: "Total value (AUD) of a customer's orders"
    tests:
      - dbt_utils.expression_is_true:
          name: first_order_before_most_recent
          expression: "first_order <= most_recent_order"
      - dbt_utils.expression_is_true:
          name: consistent_customer_name
          expression: "first_name is not null and last_name is not null"
      - dbt_utils.recency:
          name: recent_customer_data
          field: most_recent_order
          datepart: day
          interval: 30
      - dbt_utils.accepted_range:
          name: reasonable_order_count
          column_name: number_of_orders
          min_value: 1
          max_value: 1000
      - accepted_values:
          name: positive_customer_lifetime_value
          column_name: customer_lifetime_value
          values: ['>0']
      - relationships:
          name: customer_id_exists_in_orders
          to: ref('orders')
          field: customer_id
